<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kasRoulette</title>
	<link rel="icon" type="image/png" href="/favicon.png">
    <style>
        :root {
            --felt: #1e5a30;
            --gold: #f1c40f;
            --red: #c0392b;
            --black: #23303b;
            --border: #ecf0f1;
            --bg: #111;
            --neon-win: #2ecc71;
            --snake: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            user-select: none;
            overflow-x: hidden;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- LAYOUT --- */
        .main-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            width: 100%;
            max-width: 1400px;
            margin-top: 10px;
        }

        .wheel-section {
            /* Changed from fixed 350px to fluid */
            flex: 0 1 auto; 
            width: 100%;
            max-width: 380px; /* Cap at original size */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .board-section {
            flex: 1;
            min-width: 300px;
            max-width: 950px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- HEADER --- */
		header {
            position: sticky;
            top: 0;
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
            width: 99%;
            margin-bottom: 15px;
            background-color: rgba(0,0,0,0);
            padding: 10px 0;
        }
		
		.header-bottom {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center; 
            position: static; 
            margin-top: 0px;
            min-height: 32px; 
        }

        .stats-row {
            display: flex;
            gap: 20px;
            background: #222;
            padding: 8px 30px;
            border-radius: 50px;
			border: 1px solid #333;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .stat-box { display: flex; align-items: center; gap: 0px; font-size: 1rem; }
        .gold-text { color: var(--gold); font-weight: bold; }
        .high-score { border-left: 1px solid #555; padding-left: 15px; color: #aaa; font-size: 0.8rem; }

		/* --- MUTE BUTTON --- */
		.mute-btn {
			position: absolute;
			top: 13px; 
			right: 10px;
			z-index: 501;
			width: 32px;
			height: 32px;
			border-radius: 8px;
			padding: 0;
			background: #222;
			border: 1px solid #333;
			cursor: pointer;
			box-shadow: 0 2px 5px rgba(0,0,0,0.5);
			transition: all 0.2s;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.mute-btn:hover { background: #333; border-color: #555; }
		.mute-btn.muted { background: rgba(192, 57, 43, 0.2); border-color: #c0392b; }
		.mute-btn svg { width: 16px; height: 16px; fill: #aaa; pointer-events: none; }
		.mute-btn:hover svg { fill: white; }
		.mute-btn.muted svg { fill: #c0392b; } 
		
        .history-bar {
            display: none;
            gap: 3px;
			display: flex;
            gap: 5px;
            height: auto; 
            align-items: center;
            opacity: 1;
            margin-top: 0px;
            background: #222;
            padding: 4px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: 1px solid #333;
			text-shadow: 0px 1px 4px rgba(0,0,0,1);
        }
        .history-dot {
            width: 18px; height: 18px;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 9px; font-weight: bold;
            border: 1px solid #444;
            cursor: default;
			text-shadow: 0px 1px 4px rgba(0,0,0,1);
			box-shadow: 0px 1px 4px rgba(0,0,0,0.1);
        }
        .dot-red { background: var(--red); color: white; }
        .dot-black { background: var(--black); color: white; }
        .dot-green { background: var(--felt); color: var(--gold); border: 1px solid var(--gold); }
        .history-label { font-size: 0.7rem; color: #ccc; margin-right: 5px; text-transform: uppercase; letter-spacing: 1px; }

        /* --- WHEEL SVG --- */
        .wheel-svg-container {
            width: 100%; /* Fluid width */
            height: auto; /* Auto height */
            aspect-ratio: 1 / 1; /* Keep it square */
            max-width: 380px;
            position: relative;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.8));
        }
        #wheelGroup {
            transition: transform 8s cubic-bezier(0.1, 0.8, 0.1, 1);
            transform-origin: center;
        }

        .wheel-rim { fill: #444; stroke: var(--gold); stroke-width: 8; }
        .wheel-center { fill: var(--gold); }
        .wedge { stroke: #fff; stroke-width: 0.5px; }
        .wedge-label { 
            fill: white; font-size: 10px; font-weight: bold; 
            text-anchor: middle; dominant-baseline: middle;
        }
        .ball-marker { fill: white; filter: drop-shadow(0 0 5px white); }
        .marker-contain { pointer-events: none; }

        /* --- BOARD SVG --- */
        .table-container {
            width: 100%;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
            margin-bottom: 20px;
        }

        svg.board-svg {
            width: 100%;
            height: auto;
            cursor: pointer;
        }

        .zone { 
            stroke: var(--border); 
            stroke-width: 1px; 
            transition: fill 0.1s; /* Smooth color transition */
        }
        
        .zone-red { fill: var(--red); }
        .zone-black { fill: var(--black); }
        .zone-green { fill: var(--felt); stroke: var(--border); }
        
        .zone-label { 
            fill: white; font-weight: bold; font-size: 16px; 
            pointer-events: none; text-anchor: middle; dominant-baseline: middle;
        }
        .label-rotated { transform-box: fill-box; transform-origin: center; transform: rotate(-90deg); }

        @keyframes pulse {
            0% { fill: var(--neon-win); opacity: 1; }
            50% { fill: white; opacity: 1; }
            100% { fill: var(--neon-win); opacity: 1; }
        }
        .winner-anim {
            animation: pulse 0.8s infinite;
            stroke: var(--gold) !important;
            stroke-width: 3px !important;
            z-index: 10;
        }

        /* --- HITBOX VISUALIZATION --- */
        .hitbox { 
            fill: transparent; 
            stroke: none; 
            transition: fill 0.1s; 
            cursor: pointer; 
        }
        .zone:hover, .hitbox:hover {
            fill: rgba(241, 196, 15, 0.4) !important; /* Override base colors (Red/Black/Green) */
            opacity: 1; /* Ensure full visibility of the highlight */
        }

        /* Chips */
        #chipLayer { pointer-events: none; }
        .chip-body { fill: white; stroke: var(--gold); stroke-width: 3px; stroke-dasharray: 4 2; }
        .chip-text { font-size: 11px; font-weight: bold; fill: black; text-anchor: middle; dominant-baseline: middle; }
        .chip-shadow { fill: rgba(0,0,0,0.5); }

        /* --- CONTROLS --- */
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #333;
        }

        .controls-row {
            display: flex;
            gap: 8px;
            justify-content: center;
            width: 100%;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px; font-size: 0.80rem; border: none; border-radius: 5px;
            cursor: pointer; font-weight: bold; text-transform: uppercase;
            box-shadow: 0 4px 0 #000; transition: transform 0.1s;
            min-width: 90px;
            flex: 1;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }
        
        .btn-spin { background: var(--gold); color: #111; flex-grow: 2; max-width: 100%; word-break: break-word; min-width: 0; font-size: clamp(9px, 2vw, 12px) !important;}
        .btn-clear { background: #c0392b; color: white; word-break: break-word; min-width: 0; font-size: clamp(9px, 2vw, 12px) !important;}
        .btn-rebet { background: #3498db; color: white; word-break: break-word; min-width: 0; font-size: clamp(9px, 2vw, 12px) !important;}
		.btn-special { background: #8e44ad; color: white; font-size: clamp(9px, 2vw, 12px) !important;
			white-space: normal;      
			word-break: break-word;   
			line-height: 1.1;         
			padding: 6px 2px
			min-height: 40px;
			min-width: 0;             
			display: flex;
			justify-content: center;
			align-items: center;
		}
        
		.special-menu {
			display: none;
			gap: 5px; 
			width: 100%;
			background: #222;
			padding: 6px; 
			border-radius: 8px;
			margin-bottom: 10px;
			border: 1px solid #444;
			box-sizing: border-box; 
		}
		
		.special-menu.active { 
			display: grid; 
			grid-template-columns: repeat(5, 1fr); 
			grid-auto-rows: 1fr; 
		}
		
		.special-menu .btn {
			font-size: clamp(8px, 2vw, 12px) !important;
			min-height: 32px;
			height: 100%;
			padding: 10px;
			line-height: 1.0;
			white-space: normal;
			word-break: break-word;
			text-align: center;
			display: flex;
			justify-content: center;
			align-items: center;
			box-shadow: none;
			border: 1px solid rgba(255,255,255,0.15);
			min-width: 0;
		}

        .msg-display {
            min-height: 25px; margin-bottom: 10px; 
            color: var(--gold); font-size: 1.2rem; font-weight: bold;
            text-align: center; text-shadow: 0 2px 4px black;
        }

        .instruction-text {
            color: #666; margin-top: 5px; font-size: 0.8rem;
            text-align: center; line-height: 1.4;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal {
            background: #222; border: 2px solid var(--gold); padding: 30px;
            text-align: center; border-radius: 10px; box-shadow: 0 0 30px var(--gold);
        }
		
		/* --- CHIP SELECTOR --- */
        .chip-bar {
			display: flex;
			justify-content: center;
            gap: 12px;
            background: #1e5a30;
            width: 100%;
            padding: 3% 5px 2% 5px; 
            border-bottom-left-radius: 15px;
			border-bottom-right-radius: 15px;
			box-shadow: 0 10px 10px -5px rgba(0,0,0,0.5);
			position: relative;
			z-index: 5;
			box-sizing: border-box;
            margin-top: -7%;
            margin-bottom: 20px;
            flex-wrap: wrap; 
        }
		.chip-msg {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            font-style: italic;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0px 1px 2px black;
            pointer-events: none; 
            white-space: nowrap;
			
        }
		#hoverMsgType { 
            right: 22px; 
            margin-top: -6px; /* Positions it 15px above the "Pays" line */
            color: var(--gold); /* Optional: Gold color to distinguish the header */
            font-weight: bold;
        }
        #hoverMsgLeft { right: 22px; margin-top: 9px}
        #hoverMsgRight { right: 22px; margin-top: 24px }

        .chip {
            width: clamp(32px, 9vw, 64px);
			height: clamp(32px, 9vw, 64px);
            border-radius: 50%;
            border: 5px dashed white;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; 
			font-size: clamp(9px, 2.5vw, 12px); 
			color: white;
            cursor: pointer; text-shadow: 1px 1px 2px black;
            box-shadow: 0 3px 5px rgba(0,0,0,0.5);
            transition: transform 0.1s, box-shadow 0.1s;
            user-select: none;
            flex-shrink: 0;
        }

        .chip:hover { transform: translateY(-3px); }
        .chip:active { transform: scale(0.95); }
        
        .chip.active { 
            border-style: solid;
            box-shadow: 0 0 10px var(--gold), inset 0 0 10px rgba(0,0,0,0.5); 
            transform: scale(1.15);
            z-index: 10;
        }

        .chip-10 { background: #e74c3c; border-color: white; }
        .chip-20 { background: #7f8c8d; border-color: white; }
        .chip-50 { background: #e67e22; border-color: white; }
        .chip-100 { background: #23303b; border-color: white; }
        .chip-200 { background: #9b59b6; border-color: white; }
        .chip-500 { background: #3498db; border-color: white; }

		@media (max-width: 760px) {
            .chip-msg {
                display: none !important;
			}
			
			.history-dot:nth-of-type(n+9) {
                display: none;
            }
			
            body {
                padding: 5px;
                overflow-x: hidden; 
            }
            
            .main-container {
                gap: 20px;
                width: 100%;
            }

            .board-section {
                min-width: 0; 
                width: 100%;
            }

            .controls {
                width: 100%;
                box-sizing: border-box; 
                padding: 10px; 
            }

            .btn {
                min-width: 60px; 
                padding: 10px 5px; 
                font-size: 0.75rem; 
            }
            
            .special-menu.active {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .chip-bar {
                gap: 8px;
            }
			
			.chip {
                width: clamp(32px, 9vw, 40px);
                height: clamp(32px, 9vw, 40px);
				border: 3px dashed white;
			}
			
			.header-bottom {
                display: flex;
                flex-direction: row;
                align-items: center; 
                justify-content: center;
                gap: 10px; 
                padding: 0 10px;
                margin-top: 0px; /* Reduced margin for tighter mobile look */
                position: relative;
            }

            /* 2. Reset the Mute Button to flow naturally */
            .mute-btn {
                position: static; /* CRITICAL: Snaps button out of top-right corner */
                top: auto; 
                right: auto;
                margin: 0;
                
                /* Match History Bar Visuals */
                width: 30px;
                height: 30px;
                flex-shrink: 0; 
                border-radius: 50%;
            }
            /* 3. Ensure History Bar fits nicely */
            .history-bar {
                margin-top: 0;
                flex: 0 1 auto; 
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="stats-row">
            <div class="stat-box">Balance: $<span id="balanceDisplay" class="gold-text">500</span></div>
            <div class="stat-box">Bet: $<span id="betDisplay">0</span></div>
            <div class="stat-box high-score">Best: $<span id="highScoreDisplay">500</span></div>
        </div>
        
        <div class="header-bottom">
            <div class="history-bar" id="historyContainer">
                <span class="history-label">History</span>
            </div>
            <button class="mute-btn" id="btnMute" onclick="toggleMute()"></button>
        </div>
    </header>
    <div class="main-container">
        
        <div class="wheel-section">
            <div class="wheel-svg-container" onclick="spin()" style="cursor: pointer;">
                <svg viewBox="0 0 400 400">
                    <circle cx="200" cy="200" r="195" class="wheel-rim" />
                    <g id="wheelGroup"></g>
                    <circle cx="200" cy="200" r="20" class="wheel-center" />
                    <circle cx="200" cy="200" r="150" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1" />
                    
                    <g class="marker-contain">
                        <circle cx="200" cy="35" r="7" fill="rgba(0,0,0,0.5)" />
                        <circle cx="200" cy="32" r="7" class="ball-marker" />
                        <path d="M 200 45 L 194 55 L 206 55 Z" fill="var(--gold)" />
                    </g>
                </svg>
            </div>
        </div>

        <div class="board-section">
            
            <div class="table-container" style="margin-bottom: 0;"> 
                <svg id="boardSvg" class="board-svg" viewBox="0 0 920 350">
                    <rect x="0" y="0" width="920" height="350" fill="#1e5a30" rx="15" ry="15" oncontextmenu="return false;" />
                    
                    <g transform="translate(26, 0)">
                        <g id="gridLayer"></g>
                        <g id="hitboxLayer"></g>
                        <g id="textLayer"></g>
                        <g id="chipLayer" style="pointer-events: none;"></g>
                        

                    </g>
                </svg>
            </div>

            <div class="chip-bar">
                <span id="hoverMsgType" class="chip-msg"></span>
                <span id="hoverMsgLeft" class="chip-msg"></span>
                <span id="hoverMsgRight" class="chip-msg"></span>
					<div class="chip chip-10 active" onclick="selectChip(10)">10</div>
					<div class="chip chip-20" onclick="selectChip(20)">20</div>
					<div class="chip chip-50" onclick="selectChip(50)">50</div>
					<div class="chip chip-100" onclick="selectChip(100)">100</div>
					<div class="chip chip-200" onclick="selectChip(200)">200</div>
					<div class="chip chip-500" onclick="selectChip(500)">500</div>
            </div>

            <div class="controls">
                <div class="msg-display" id="msg">Place your bets</div>
                
                <div id="specialMenu" class="special-menu">
                    <button class="btn btn-special btn-sm" onclick="placePattern('007')">007 Strat</button>
                    <button class="btn btn-special btn-sm" onclick="placePattern('snake')">Red Snake</button>
                    <button class="btn btn-special btn-sm" onclick="placePattern('3_2_red')">3/2 Red</button>
                    <button class="btn btn-special btn-sm" onclick="placePattern('romanosky')">Romanosky</button>
                    <button class="btn btn-special btn-sm" onclick="placePattern('five_quad')">Five Quad</button>
                    <button class="btn btn-special btn-sm" onclick="placePattern('shotwell')">Shotwell</button>
                    <button class="btn btn-special btn-sm" onclick="placePattern('666')">666 Strat</button>
                    <button class="btn btn-special btn-sm" onclick="placePattern('kavouras')">Kavouras</button>
                    <button class="btn btn-special btn-sm" onclick="placePattern('5x5')">5x5 Strat</button>
                    <button class="btn btn-special btn-sm" onclick="placePattern('triple_cols')">3x Columns</button>
                </div>

                <div class="controls-row">
                    <button class="btn btn-clear" onclick="clearBets()" id="btnClear">Clear</button>
                    <button class="btn btn-rebet" onclick="rebet()" id="btnRebet">Rebet</button>
                    <button class="btn btn-rebet" onclick="doubleBet()" id="btnDouble">x2</button>
                    <button class="btn btn-special" onclick="toggleSpecial()" id="btnSpecial">Easy Bets</button>
                </div>
                <div class="controls-row">
                    <button class="btn btn-spin" onclick="spin()" id="spinBtn">SPIN</button>
                </div>

                <div class="instruction-text">
                    L-Click: Bet $10 &bull; R-Click: Remove $10
                </div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="gameOverModal">
        <div class="modal">
            <h2>BANKRUPT!</h2>
            <p>The house always wins... eventually.</p>
            <button class="btn btn-rebet" onclick="restartGame()">Restart with $500</button>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const WHEEL_ORDER = [0, 28, 9, 26, 30, 11, 7, 20, 32, 17, 5, 22, 34, 15, 3, 24, 36, 13, 1, '00', 27, 10, 25, 29, 12, 8, 19, 31, 18, 6, 21, 33, 16, 4, 23, 35, 14, 2];
        const REDS = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
        const SNAKE_NUMS = [1, 5, 9, 12, 14, 16, 19, 23, 27, 30, 32, 34]; 
        
        const CELL_W = 60;
        const CELL_H = 50;
        const GRID_X = 100;
        const GRID_Y = 20;
        const SPIN_DURATION_MS = 7800; 
        const MAX_HISTORY = 12;

        // --- AUDIO IMPLEMENTATION (WEB AUDIO API) ---
        let isMuted = false;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        const soundConfig = {
            click: { url: 'click.mp3', vol: 0.4 },
            spin:  { url: 'spin.mp3',  vol: 0.5 },
            win:   { url: 'win.mp3',   vol: 0.6 },
            lose:  { url: 'lose.mp3',  vol: 0.5 }
        };

        const soundBuffers = {};
        let currentSpinSource = null;

        async function loadAllSounds() {
            for (const [key, config] of Object.entries(soundConfig)) {
                try {
                    const response = await fetch(config.url);
                    const arrayBuffer = await response.arrayBuffer();
                    soundBuffers[key] = await audioCtx.decodeAudioData(arrayBuffer);
                } catch (e) {
                    console.warn(`Audio ${key} failed to load:`, e);
                }
            }
        }
        loadAllSounds();

        function unlockAudio() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            document.removeEventListener('click', unlockAudio);
            document.removeEventListener('touchstart', unlockAudio);
        }
        document.addEventListener('click', unlockAudio);
        document.addEventListener('touchstart', unlockAudio);

        function playSound(name) {
            if(isMuted || !soundBuffers[name]) return;

            if (name === 'spin' && currentSpinSource) {
                try { currentSpinSource.stop(); } catch(e){}
                currentSpinSource = null;
            }

            const source = audioCtx.createBufferSource();
            source.buffer = soundBuffers[name];
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = soundConfig[name].vol;
            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            source.start(0);

            if (name === 'spin') currentSpinSource = source;
        }
        
        function stopSound(name) {
            if (name === 'spin' && currentSpinSource) {
                try { 
                    currentSpinSource.stop();
                    currentSpinSource = null;
                } catch(e) {}
            }
        }

		// --- AUDIO ICONS ---
        const ICON_SOUND_ON = `<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
        const ICON_SOUND_OFF = `<svg viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>`;

        function toggleMute() {
            isMuted = !isMuted;
            localStorage.setItem('rouletteMuted', isMuted);
            updateMuteUI();
            if (isMuted && currentSpinSource) stopSound('spin');
        }

        function updateMuteUI() {
            const btn = document.getElementById('btnMute');
            if(isMuted) {
                btn.innerHTML = ICON_SOUND_OFF;
                btn.classList.add('muted');
            } else {
                btn.innerHTML = ICON_SOUND_ON;
                btn.classList.remove('muted');
            }
        }

        // --- STATE ---
		let currentChipValue = 10;
        
        // Load Balance from LocalStorage (or default to 500)
        let balance = parseInt(localStorage.getItem('rouletteBalance')) || 500;
        
        let bets = {};
        let lastBets = {}; 
        let zoneCenters = {}; 
        let isSpinning = false;
        let currentWheelRotation = 0;
        let history = JSON.parse(localStorage.getItem('rouletteHistory')) || [];
        let highScore = localStorage.getItem('rouletteProMaxHighScore') || 500;

        window.onload = () => {
            // Restore Mute State
            const savedMute = localStorage.getItem('rouletteMuted');
            if (savedMute === 'true') isMuted = true;
            updateMuteUI();

            // If user was bankrupt on reload, reset to 0 but show modal immediately
            if (balance <= 0) {
                 setTimeout(() => document.getElementById('gameOverModal').style.display = 'flex', 100);
            }

            document.getElementById('balanceDisplay').innerText = balance;
            document.getElementById('highScoreDisplay').innerText = highScore;
            drawWheel();
            drawBoard();
			drawHistory();
            document.getElementById('boardSvg').addEventListener('contextmenu', event => event.preventDefault());
        };

        // --- RENDER FUNCTIONS ---
        function drawWheel() {
            const group = document.getElementById('wheelGroup');
            const radius = 190;
            const cx = 200, cy = 200;
            const sliceDeg = 360 / WHEEL_ORDER.length;

            WHEEL_ORDER.forEach((val, i) => {
                const startAngle = (i * sliceDeg) - 90 - (sliceDeg/2);
                const endAngle = startAngle + sliceDeg;
                const x1 = cx + radius * Math.cos(Math.PI * startAngle / 180);
                const y1 = cy + radius * Math.sin(Math.PI * startAngle / 180);
                const x2 = cx + radius * Math.cos(Math.PI * endAngle / 180);
                const y2 = cy + radius * Math.sin(Math.PI * endAngle / 180);

                const d = `M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 0 1 ${x2} ${y2} Z`;
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", d);
                path.setAttribute("class", "wedge");
                
                if (val === 0 || val === '00') path.setAttribute("fill", "#1e5a30");
                else if (REDS.includes(val)) path.setAttribute("fill", "#c0392b");
                else path.setAttribute("fill", "#23303b");
                group.appendChild(path);

                const textAngle = (i * sliceDeg) - 90;
                const tx = cx + (radius * 0.85) * Math.cos(Math.PI * textAngle / 180);
                const ty = cy + (radius * 0.85) * Math.sin(Math.PI * textAngle / 180);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", tx); text.setAttribute("y", ty);
                text.setAttribute("class", "wedge-label");
                text.setAttribute("transform", `rotate(${textAngle + 90}, ${tx}, ${ty})`);
                text.textContent = val;
                group.appendChild(text);
            });
        }

		function drawRect(id, x, y, w, h, color, labelText, rotate = false) {
            const grid = document.getElementById('gridLayer');
            const textL = document.getElementById('textLayer');
            const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("id", "zone_"+id);
            rect.setAttribute("x", x); rect.setAttribute("y", y);
            rect.setAttribute("width", w); rect.setAttribute("height", h);
            rect.setAttribute("class", `zone ${color}`);
            
            // Interaction & Hover
            rect.addEventListener('click', () => placeBet(id));
            rect.addEventListener('contextmenu', (e) => { e.preventDefault(); removeBet(id); });
            rect.addEventListener('mouseenter', () => showHoverInfo(id));
            rect.addEventListener('mouseleave', () => clearHoverInfo());

            grid.appendChild(rect);

            if (labelText) {
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("x", x + w/2);
                txt.setAttribute("y", y + h/2 + 1);
                txt.setAttribute("class", `zone-label ${rotate ? 'label-rotated' : ''}`);
                txt.textContent = labelText;
                textL.appendChild(txt);
            }
            zoneCenters[id] = { x: x + w/2, y: y + h/2 };
        }

        function drawHitbox(id, x, y, w, h, label) {
            const layer = document.getElementById('hitboxLayer');
            const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("x", x); rect.setAttribute("y", y);
            rect.setAttribute("width", w); rect.setAttribute("height", h);
            rect.setAttribute("class", "hitbox");
            
            const title = document.createElementNS("http://www.w3.org/2000/svg", "title");
            title.textContent = label;
            rect.appendChild(title);
            
            // Interaction & Hover
            rect.addEventListener('click', () => placeBet(id));
            rect.addEventListener('contextmenu', (e) => { e.preventDefault(); removeBet(id); });
            rect.addEventListener('mouseenter', () => showHoverInfo(id));
            rect.addEventListener('mouseleave', () => clearHoverInfo());

            layer.appendChild(rect);
            zoneCenters[id] = { x: x + w/2, y: y + h/2 };
        }

		function drawBoard() {
            const zeroH = (CELL_H * 3) / 2;
            
            // 00 and 0 Backgrounds
            draw00And0(zeroH);

            // Numbers 1-36 Backgrounds
            for(let i=1; i<=36; i++){
                let r = (i%3===0)?0 : (i%3===2)?1 : 2;
                let c = Math.ceil(i/3)-1;
                let color = REDS.includes(i) ? 'zone-red' : 'zone-black';
                drawRect(i.toString(), GRID_X + c*CELL_W, GRID_Y + r*CELL_H, CELL_W, CELL_H, color, i);
            }

            // UPDATED: Hitbox thickness set to 22
            const HIT_SIZE = 22; 
            
            // --- 1. VERTICAL SPLITS (Side-by-Side numbers) ---
            for (let c = 0; c < 11; c++) {
                const x = GRID_X + (c + 1) * CELL_W - (HIT_SIZE / 2);
                for (let r = 0; r < 3; r++) {
                    const y = GRID_Y + r * CELL_H + 5; // +5 matches vertical padding logic
                    const valLeft = (c * 3) + (3-r);
                    const valRight = ((c + 1) * 3) + (3-r);
                    drawHitbox(`split_${valLeft}_${valRight}`, x, y, HIT_SIZE, CELL_H - 10, `Split ${valLeft}-${valRight}`);
                }
            }

            // --- 2. HORIZONTAL SPLITS (Stacked numbers) ---
            for (let c = 0; c < 12; c++) {
                const x = GRID_X + c * CELL_W + 5;
                for (let r = 0; r < 2; r++) {
                    const y = GRID_Y + (r + 1) * CELL_H - (HIT_SIZE / 2);
                    const valBot = (c * 3) + (3 - (r+1)); 
                    const valTop = valBot + 1;
                    drawHitbox(`split_${valBot}_${valTop}`, x, y, CELL_W - 10, HIT_SIZE, `Split ${valBot}-${valTop}`);
                }
            }

            // --- 3. CORNERS (Quad bets) ---
            for (let c = 0; c < 11; c++) {
                const x = GRID_X + (c + 1) * CELL_W - (HIT_SIZE / 2);
                for (let r = 0; r < 2; r++) {
                    const y = GRID_Y + (r + 1) * CELL_H - (HIT_SIZE / 2);
                    const tl = (c * 3) + (2 - r);
                    drawHitbox(`corner_${tl}`, x, y, HIT_SIZE, HIT_SIZE, `Corner`);
                }
            }

            // --- 4. STREETS (Top and Bottom edges) ---
            for (let c = 0; c < 12; c++) {
                const x = GRID_X + c * CELL_W;
                const startNum = (c * 3) + 1; 
                
                // Top Street
                drawHitbox(`street_${startNum}`, x, GRID_Y - (HIT_SIZE / 2), CELL_W, HIT_SIZE, `Street ${startNum}-${startNum+2}`);
                
                // Bottom Street
                drawHitbox(`street_${startNum}`, x, GRID_Y + (CELL_H * 3) - (HIT_SIZE / 2), CELL_W, HIT_SIZE, `Street ${startNum}-${startNum+2}`);
            }

            // --- 5. SIX LINES (Top and Bottom intersections) ---
            for (let c = 0; c < 11; c++) {
                const x = GRID_X + (c+1) * CELL_W - (HIT_SIZE / 2);
                const startNum = (c * 3) + 1;

                // Top Six Line
                drawHitbox(`sixline_${startNum}`, x, GRID_Y - (HIT_SIZE / 2), HIT_SIZE, HIT_SIZE, `Six Line`);

                // Bottom Six Line
                drawHitbox(`sixline_${startNum}`, x, GRID_Y + (CELL_H * 3) - (HIT_SIZE / 2), HIT_SIZE, HIT_SIZE, `Six Line`);
            }

            // --- 6. ZERO COMPLEX (Consistent 22px Sizing) ---
            
            // Vertical Splits on the 0-Line
            // 0-1 (Bottom Row)
            drawHitbox('split_0_1', GRID_X - (HIT_SIZE / 2), GRID_Y + (CELL_H * 2) + 5, HIT_SIZE, CELL_H - 10, "Split 0-1");
            
            // 0-2 (Middle Row - Bottom Half)
            drawHitbox('split_0_2', GRID_X - (HIT_SIZE / 2), GRID_Y + CELL_H + (CELL_H / 2), HIT_SIZE, CELL_H / 2, "Split 0-2");
            
            // 00-2 (Middle Row - Top Half)
            drawHitbox('split_00_2', GRID_X - (HIT_SIZE / 2), GRID_Y + CELL_H, HIT_SIZE, CELL_H / 2, "Split 00-2");
            
            // 00-3 (Top Row)
            drawHitbox('split_00_3', GRID_X - (HIT_SIZE / 2), GRID_Y + 5, HIT_SIZE, CELL_H - 10, "Split 00-3");

            // Basket / Trios
            // Intersection 0-1-2
            drawHitbox('trio_0_1_2', GRID_X - (HIT_SIZE / 2), GRID_Y + (CELL_H * 2) - (HIT_SIZE / 2), HIT_SIZE, HIT_SIZE, "Basket 0-1-2");
            
            // Intersection 00-2-3
            drawHitbox('trio_00_2_3', GRID_X - (HIT_SIZE / 2), GRID_Y + CELL_H - (HIT_SIZE / 2), HIT_SIZE, HIT_SIZE, "Basket 00-2-3");
            
            // 0-00 Split
            drawHitbox('split_0_00', 20, GRID_Y + zeroH - (HIT_SIZE / 2), GRID_X - 20, HIT_SIZE, "Split 0-00");

            // Top Line (0,00,1,2,3)
            // Bottom Corner (0-1 intersection extended)
            drawHitbox('topline', GRID_X - (HIT_SIZE / 2), GRID_Y + (CELL_H * 3) - (HIT_SIZE / 2), HIT_SIZE, HIT_SIZE, "Top Line (0,00,1,2,3)");
            
            // Top Corner (00-3 intersection extended)
            drawHitbox('topline', GRID_X - (HIT_SIZE / 2), GRID_Y - (HIT_SIZE / 2), HIT_SIZE, HIT_SIZE, "Top Line (0,00,1,2,3)");

            drawOutsideBets();
        }

		function draw00And0(zeroH) {
            // 00 (Top Half)
            const p00 = document.createElementNS("http://www.w3.org/2000/svg", "path");
            p00.setAttribute("id", "zone_00");
            p00.setAttribute("d", `M 20 ${GRID_Y} L ${GRID_X} ${GRID_Y} L ${GRID_X} ${GRID_Y + zeroH} L 20 ${GRID_Y + zeroH} L 0 ${GRID_Y + zeroH/2} Z`);
            p00.setAttribute("class", "zone zone-green");
            
            // Interaction & Hover
            p00.addEventListener('click', () => placeBet('00'));
            // ADDED: Right-click listener for 00
            p00.addEventListener('contextmenu', (e) => { e.preventDefault(); removeBet('00'); });
            p00.addEventListener('mouseenter', () => showHoverInfo('00'));
            p00.addEventListener('mouseleave', () => clearHoverInfo());

            document.getElementById('gridLayer').appendChild(p00);
            
            const t00 = document.createElementNS("http://www.w3.org/2000/svg", "text");
            t00.setAttribute("x", 45); t00.setAttribute("y", GRID_Y + zeroH/2);
            t00.setAttribute("class", "zone-label"); t00.textContent = "00";
            document.getElementById('textLayer').appendChild(t00);
            zoneCenters['00'] = {x:45, y:GRID_Y + zeroH/2};

            // 0 (Bottom Half)
            const y0 = GRID_Y + zeroH;
            const p0 = document.createElementNS("http://www.w3.org/2000/svg", "path");
            p0.setAttribute("id", "zone_0");
            p0.setAttribute("d", `M 20 ${y0} L ${GRID_X} ${y0} L ${GRID_X} ${y0 + zeroH} L 20 ${y0 + zeroH} L 0 ${y0 + zeroH/2} Z`);
            p0.setAttribute("class", "zone zone-green");
            
            // Interaction & Hover
            p0.addEventListener('click', () => placeBet('0'));
            // ADDED: Right-click listener for 0
            p0.addEventListener('contextmenu', (e) => { e.preventDefault(); removeBet('0'); });
            p0.addEventListener('mouseenter', () => showHoverInfo('0'));
            p0.addEventListener('mouseleave', () => clearHoverInfo());

            document.getElementById('gridLayer').appendChild(p0);

            const t0 = document.createElementNS("http://www.w3.org/2000/svg", "text");
            t0.setAttribute("x", 45); t0.setAttribute("y", y0 + zeroH/2);
            t0.setAttribute("class", "zone-label"); t0.textContent = "0";
            document.getElementById('textLayer').appendChild(t0);
            zoneCenters['0'] = {x:45, y:y0 + zeroH/2};
        }

        function drawOutsideBets() {
            const endX = GRID_X + 12*CELL_W;
            // Columns
            drawRect('c3', endX, GRID_Y, 40, CELL_H, 'zone-green', '2:1', true);
            drawRect('c2', endX, GRID_Y+CELL_H, 40, CELL_H, 'zone-green', '2:1', true);
            drawRect('c1', endX, GRID_Y+CELL_H*2, 40, CELL_H, 'zone-green', '2:1', true);

            // Dozens
            const botY = GRID_Y + 3*CELL_H;
            const dozW = 4*CELL_W;
            drawRect('dozen1', GRID_X, botY, dozW, CELL_H, 'zone-green', '1st 12');
            drawRect('dozen2', GRID_X+dozW, botY, dozW, CELL_H, 'zone-green', '2nd 12');
            drawRect('dozen3', GRID_X+dozW*2, botY, dozW, CELL_H, 'zone-green', '3rd 12');

            // 50/50s
            const botY2 = botY + CELL_H;
            const simW = 2*CELL_W;
            drawRect('low', GRID_X, botY2, simW, CELL_H, 'zone-green', '1-18');
            drawRect('even', GRID_X+simW, botY2, simW, CELL_H, 'zone-green', 'EVEN');
            drawRect('red', GRID_X+simW*2, botY2, simW, CELL_H, 'zone-red', 'RED');
            drawRect('black', GRID_X+simW*3, botY2, simW, CELL_H, 'zone-black', 'BLK');
            drawRect('odd', GRID_X+simW*4, botY2, simW, CELL_H, 'zone-green', 'ODD');
            drawRect('high', GRID_X+simW*5, botY2, simW, CELL_H, 'zone-green', '19-36');
        }

        // --- LOGIC ---
        function clearWinnerHighlight() {
            document.querySelectorAll('.winner-anim').forEach(e => e.classList.remove('winner-anim'));
        }

		function selectChip(val) {
            currentChipValue = val;
            playSound('click'); 
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            document.querySelector(`.chip-${val}`).classList.add('active');
            const instr = document.querySelector('.instruction-text');
            if(instr) instr.innerHTML = `L-Click: Bet $${val} &bull; R-Click: Remove $${val}`;
        }

        function placeBet(id, amount = null) {
            if(isSpinning) return;
            
            clearWinnerHighlight();

            let val = amount !== null ? amount : currentChipValue;
            const currentTotal = Object.values(bets).reduce((a,b)=>a+b,0);
            
            // ALL-IN LOGIC
            if (currentTotal + val > balance) {
                // If manual click (amount is null), try to bet remainder
                if (amount === null) {
                    const remaining = balance - currentTotal;
                    if (remaining > 0) {
                        val = remaining;
                    } else {
                        return showMsg("Insufficient funds!", '#ff6b6b');
                    }
                } else {
                    // If pattern bet, strict check
                    return showMsg("Insufficient funds!", '#ff6b6b');
                }
            }

            if(!bets[id]) bets[id]=0;
            bets[id] += val;
            updateUI();
            
            if(amount === null) {
                playSound('click');
                // Format Label
                let label = "Bet";
                if(id.startsWith('split')) label = "Split Bet";
                else if(id.startsWith('corner')) label = "Corner Bet";
                else if(id.startsWith('street')) label = "Street Bet";
                else if(id.startsWith('sixline')) label = "Six Line Bet";
                else if(id.startsWith('trio') || id === 'topline') label = "Line Bet";
                else if(id.startsWith('dozen')) label = "Dozen Bet";
				else if(id.startsWith('c')) label = "Column Bet";
                else if(id.startsWith('red')) label = "Red Bet";
				else if(id.startsWith('black')) label = "Black Bet";
				else if(id.startsWith('even')) label = "Even Bet";
				else if(id.startsWith('odd')) label = "Odd Bet";
				else if(id.startsWith('low')) label = "Low Bet";
				else if(id.startsWith('high')) label = "High Bet";
                else if(!isNaN(id) || id === '00') label = `Straight ${id}`;
                
                showMsg(`Placed $${val} ${label}`); 
            } else {
                 showMsg("Bet Placed");
            }
        }

        function toggleSpecial() {
            playSound('click');
            const m = document.getElementById('specialMenu');
            m.classList.toggle('active');
        }
		
		function placePattern(type) {
            if(isSpinning) return;
            playSound('click'); 
            clearWinnerHighlight(); // Clear highlight
            if(type === 'snake') {
                SNAKE_NUMS.forEach(n => placeBet(n.toString(), 10));
                showMsg("Red Snake Bet Placed");
            }
            else if(type === '007') {
                placeBet('high', 140); placeBet('sixline_13', 50); placeBet('split_0_00', 10);
                showMsg("007 Bet Placed");
            }
            else if(type === 'romanosky') {
                placeBet('corner_32', 10); placeBet('corner_28', 10);
                placeBet('dozen1', 30); placeBet('dozen2', 30);
                showMsg("Romanosky Bet Placed");
            }
            else if(type === 'shotwell') {
                placeBet('sixline_1', 10);
                ['8', '10', '20', '26'].forEach(n => placeBet(n, 10));
                showMsg("Shotwell Bet Placed");
            }
			else if(type === 'triple_cols') {
                placeBet('sixline_4', 50); placeBet('sixline_16', 50); placeBet('sixline_28', 50);
                placeBet('split_0_00', 10);
                showMsg("Triple Columns Bet Placed");
            }
            else if(type === '5x5') {
                placeBet('sixline_1', 10); placeBet('sixline_7', 10); placeBet('sixline_13', 10); placeBet('sixline_19', 10); placeBet('sixline_25', 10);
                showMsg("5x5 Bet Placed");
            }
            else if(type === 'five_quad') {
                placeBet('corner_5', 10); placeBet('corner_10', 10); placeBet('corner_17', 10); 
                placeBet('corner_23', 10); placeBet('corner_32', 10); placeBet('00', 10);
                showMsg("Five Quad Bet Placed");
            }
            else if(type === '3_2_red') {
                placeBet('red', 30); placeBet('c2', 20);
                showMsg("3/2 Red Bet Placed");
            }
            else if(type === 'kavouras') {
                placeBet('topline', 10); placeBet('split_8_11', 10); placeBet('split_13_14', 10);
                placeBet('split_15_18', 10); placeBet('split_17_20', 10); placeBet('split_27_30', 10);
                placeBet('corner_32', 10);
                showMsg("Kavouras Bet Placed");
            }
            else if(type === '666') {
                placeBet('red', 90);
                ['split_0_00', 'split_8_11', 'split_10_13', 'split_17_20', 'split_26_29', 'split_28_31']
                    .forEach(id => placeBet(id, 10));
                ['4', '6', '15'].forEach(n => placeBet(n, 10));
                showMsg("666 Bet Placed");
            }
        }
		
		function removeBet(id) {
            if(isSpinning) return;
            if(bets[id] && bets[id] > 0) {
                playSound('click'); 

                // Check for Mobile (matches CSS breakpoint)
                const isMobile = window.matchMedia("(max-width: 760px)").matches;

                if (isMobile) {
                    // Mobile: Remove the FULL bet on this zone immediately
                    delete bets[id];
                } else {
                    // Desktop: Decrement by current chip value
                    bets[id] -= currentChipValue;
                    if(bets[id] <= 0) delete bets[id];
                }
                
                updateUI();
            }
        }

        function clearBets() {
            if(isSpinning) return;
            clearWinnerHighlight(); // Clear highlight
            playSound('click');
            bets = {};
            updateUI();
            showMsg("Bets cleared.");
        }

        function rebet() {
            if(isSpinning) return;
            clearWinnerHighlight(); // Clear highlight
            playSound('click');
            const cost = Object.values(lastBets).reduce((a,b)=>a+b,0);
            if(cost > balance) return showMsg("Insufficient funds!", '#ff6b6b');
            bets = JSON.parse(JSON.stringify(lastBets));
            updateUI();
        }

        function doubleBet() {
            if(isSpinning) return;
            
            // 1. Calculate totals
            const currentBetTotal = Object.values(bets).reduce((a,b)=>a+b,0);
            if (currentBetTotal === 0) return; // No bets to double

            // 2. Determine funds available to add
            // We want to add `currentBetTotal` (to double), but cap at `balance`.
            // We also floor to 10 to ensure we only spend allowed increments.
            const remainingBalance = balance - currentBetTotal;
            let amountToAdd = Math.min(currentBetTotal, remainingBalance);
            amountToAdd = Math.floor(amountToAdd / 10) * 10;

            if (amountToAdd <= 0) return showMsg("Insufficient funds!", '#ff6b6b');

            playSound('click');
            clearWinnerHighlight();

            // 3. Proportional Distribution Strategy
            // We scale all bets up by the ratio of (TotalTarget / CurrentTotal)
            // Then we distribute any rounding 'dust' to the largest bets first.
            const totalTarget = currentBetTotal + amountToAdd;
            const scale = totalTarget / currentBetTotal;
            
            let allocated = 0;
            const additions = {};
            
            // Sort keys by bet size (descending) to prioritize main bets for remainders
            const keys = Object.keys(bets).sort((a,b) => bets[b] - bets[a]);

            // First pass: Scaled distribution
            for(let k of keys) {
                // Calculate target value, floored to 10
                const targetVal = Math.floor((bets[k] * scale) / 10) * 10;
                let add = targetVal - bets[k];
                if(add < 0) add = 0;
                
                additions[k] = add;
                allocated += add;
            }

            // Second pass: Distribute remainder (due to flooring) 10 by 10
            let remainder = amountToAdd - allocated;
            let i = 0;
            while(remainder >= 10) {
                // Cycle through bets (largest first) adding $10 until money runs out
                const k = keys[i % keys.length];
                additions[k] += 10;
                allocated += 10;
                remainder -= 10;
                i++;
            }

            // 4. Apply changes
            for(let k in additions) {
                bets[k] += additions[k];
            }

            updateUI();
            if (amountToAdd < currentBetTotal) {
                showMsg("Insufficient funds!", '#ff6b6b');
            } else {
                showMsg("Bets Doubled");
            }
        }

        function showMsg(text, color='var(--gold)') {
            const msg = document.getElementById('msg');
            msg.innerText = text;
            msg.style.color = color;
            if(color !== 'var(--gold)') setTimeout(() => msg.style.color = 'var(--gold)', 1500);
        }

        function updateUI() {
            document.getElementById('balanceDisplay').innerText = balance;
            const total = Object.values(bets).reduce((a,b)=>a+b,0);
            document.getElementById('betDisplay').innerText = total;

            const layer = document.getElementById('chipLayer');
            layer.innerHTML = '';
            
            // Draw chips
            for(const [id, amt] of Object.entries(bets)) {
                if(amt <= 0) continue;
                if(!zoneCenters[id]) continue; 

                const c = zoneCenters[id];
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                
                const sh = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                sh.setAttribute("cx", c.x+2); sh.setAttribute("cy", c.y+2);
                sh.setAttribute("r", 11); sh.setAttribute("class", "chip-shadow");
                g.appendChild(sh);

                const circ = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circ.setAttribute("cx", c.x); circ.setAttribute("cy", c.y);
                circ.setAttribute("r", 11); circ.setAttribute("class", "chip-body");
                g.appendChild(circ);

                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("x", c.x); txt.setAttribute("y", c.y+1);
                txt.setAttribute("class", "chip-text");
                txt.textContent = amt >= 1000 ? (amt/1000).toFixed(1)+'k' : amt;
                g.appendChild(txt);
                
                layer.appendChild(g);
            }
        }

        function spin() {
            if(isSpinning) return;
            const totalBet = Object.values(bets).reduce((a,b)=>a+b,0);
            if(totalBet === 0) return showMsg("Please place a bet!");
            
            clearWinnerHighlight(); // Ensure highlight is gone on spin
            
            // Start Spin Audio
            playSound('spin');
            
            balance -= totalBet;
            lastBets = JSON.parse(JSON.stringify(bets));
            isSpinning = true;
            updateUI();
            showMsg("No more bets...");
            
            // Spin Animation
            const rIdx = Math.floor(Math.random() * WHEEL_ORDER.length);
            const resultVal = WHEEL_ORDER[rIdx];

            const wedgeSize = 360 / WHEEL_ORDER.length;
            const destinationAngle = -1 * (rIdx * wedgeSize);
            const currentAbs = currentWheelRotation; 
            const rounds = 5 + Math.random()*3; 
            let target = currentAbs + (360 * rounds);
            const remainder = target % 360;
            const destRem = (destinationAngle + 360000) % 360; 
            let diff = destRem - remainder;
            if(diff < 0) diff += 360;
            const finalRotate = target + diff;
            currentWheelRotation = finalRotate;
            
            document.getElementById('wheelGroup').style.transform = `rotate(${finalRotate}deg)`;

            setTimeout(() => {
                resolveBet(resultVal);
            }, SPIN_DURATION_MS);
        }
		// --- HOVER & PAYOUT LOGIC ---
        function getPayoutRatio(id) {
            if (id.startsWith('split_')) return 17;
            if (id.startsWith('street_') || id.startsWith('trio_')) return 11;
            if (id.startsWith('corner_')) return 8;
            if (id === 'topline') return 6;
            if (id.startsWith('sixline_')) return 5;
            if (id.startsWith('dozen') || id.startsWith('c')) return 2;
            if (['even','odd','red','black','low','high'].includes(id)) return 1;
            if (!isNaN(id) || id === '00') return 35; // Straights (0-36, 00)
            return 0;
        }

        function showHoverInfo(id) {
            if(isSpinning) return;
            const ratio = getPayoutRatio(id);
            if(ratio === 0) return;

            // Calculate Effective Bet (All-In Logic)
            const currentTotal = Object.values(bets).reduce((a,b)=>a+b,0);
            let effectiveBet = currentChipValue;
            
            if (currentTotal + effectiveBet > balance) {
                const remaining = balance - currentTotal;
                if (remaining > 0) effectiveBet = remaining;
                else effectiveBet = 0;
            }

            const potentialWin = effectiveBet * ratio;

            // Determine Bet Type Label
            let label = "Bet";
            if(id.startsWith('split')) label = "Split Bet";
            else if(id.startsWith('corner')) label = "Corner Bet";
            else if(id.startsWith('street')) label = "Street Bet";
            else if(id.startsWith('sixline')) label = "Six Line Bet";
            else if(id === 'topline') label = "Top Line Bet";
            else if(id.startsWith('trio')) label = "Basket Bet";
            else if(id.startsWith('dozen')) label = "Dozen Bet";
            else if(id.startsWith('c')) label = "Column Bet";
            else if(id.startsWith('red')) label = "Red Bet";
            else if(id.startsWith('black')) label = "Black Bet";
            else if(id.startsWith('even')) label = "Even Bet";
            else if(id.startsWith('odd')) label = "Odd Bet";
            else if(id.startsWith('low')) label = "Low Bet";
            else if(id.startsWith('high')) label = "High Bet";
            else if(!isNaN(id) || id === '00') label = `Straight ${id}`;

            // Update UI
            const typeEl = document.getElementById('hoverMsgType');
            const leftEl = document.getElementById('hoverMsgLeft');
            const rightEl = document.getElementById('hoverMsgRight');
            
            if(typeEl) typeEl.textContent = label;
            if(leftEl) leftEl.textContent = `Pays ${ratio}:1`;
            if(rightEl) rightEl.textContent = `Max Payout: $${potentialWin}`;
        }

        function clearHoverInfo() {
            const typeEl = document.getElementById('hoverMsgType');
            const leftEl = document.getElementById('hoverMsgLeft');
            const rightEl = document.getElementById('hoverMsgRight');
            if(typeEl) typeEl.textContent = '';
            if(leftEl) leftEl.textContent = '';
            if(rightEl) rightEl.textContent = '';
        }
        function resolveBet(result) {
            isSpinning = false;
            
            // Stop Spin Audio
            stopSound('spin');

            // History
			history.unshift(result);
			if(history.length > MAX_HISTORY) history.pop();

			// Save to local storage
			localStorage.setItem('rouletteHistory', JSON.stringify(history));

			// Update the visual bar
			drawHistory();

            // Calc Winnings
            let totalWin = 0;
            const num = (result === '00') ? -1 : parseInt(result);
            
            for(const [id, amt] of Object.entries(bets)) {
                let payout = 0;
                
                if(id === result.toString()) payout = 35;
                else if(id.startsWith('split_')) {
                    const parts = id.split('_');
                    const n1 = parts[1];
                    const n2 = parts[2];
                    if(n1 === result.toString() || n2 === result.toString()) payout = 17;
                }
                else if(id.startsWith('street_')) {
                    const s = parseInt(id.split('_')[1]);
                    if(num >= s && num <= s+2 && num !== -1 && result !== 0) payout = 11;
                }
                else if(id.startsWith('corner_')) {
                    const s = parseInt(id.split('_')[1]);
                    const grp = [s, s+1, s+3, s+4];
                    if(grp.includes(num)) payout = 8;
                }
                else if(id.startsWith('sixline_')) {
                    const s = parseInt(id.split('_')[1]);
                    if(num >= s && num <= s+5 && num !== -1 && result !== 0) payout = 5;
                }
                else if(id === 'trio_0_1_2') {
                    if([0, 1, 2].includes(num)) payout = 11;
                }
                else if(id === 'trio_00_2_3') {
                    if(result === '00' || num === 2 || num === 3) payout = 11;
                }
                else if(id === 'topline') {
                    if(result === '00' || (num >= 0 && num <= 3)) payout = 6;
                }
                else if(result !== 0 && result !== '00') {
                    if(id === 'red' && REDS.includes(num)) payout = 1;
                    if(id === 'black' && !REDS.includes(num)) payout = 1;
                    if(id === 'even' && num % 2 === 0) payout = 1;
                    if(id === 'odd' && num % 2 !== 0) payout = 1;
                    if(id === 'low' && num <= 18) payout = 1;
                    if(id === 'high' && num >= 19) payout = 1;
                    if(id === 'dozen1' && num <= 12) payout = 2;
                    if(id === 'dozen2' && num > 12 && num <= 24) payout = 2;
                    if(id === 'dozen3' && num > 24) payout = 2;
                    if(id === 'c1' && num % 3 === 1) payout = 2;
                    if(id === 'c2' && num % 3 === 2) payout = 2;
                    if(id === 'c3' && num % 3 === 0) payout = 2;
                }
                if(payout > 0) totalWin += amt + (amt * payout);
            }

            // Animate Winner
            document.querySelectorAll('.winner-anim').forEach(e=>e.classList.remove('winner-anim'));
            const wEl = document.getElementById('zone_'+result);
            if(wEl) wEl.classList.add('winner-anim');

            if(totalWin > 0) {
                balance += totalWin;
                playSound('win');
                showMsg(`Result: ${result} | WIN: $${totalWin}`, '#2ecc71');
            } else {
                playSound('lose');
                showMsg(`Result: ${result}`, '#ecf0f1');
            }
            
            // Save Balance to LocalStorage
            localStorage.setItem('rouletteBalance', balance);
            
            bets = {};
            updateUI();
            
            if(balance > highScore) {
                highScore = balance;
                localStorage.setItem('rouletteProMaxHighScore', highScore);
                document.getElementById('highScoreDisplay').innerText = highScore;
            }
            
            if(balance <= 0) {
                setTimeout(() => document.getElementById('gameOverModal').style.display = 'flex', 2000);
            }
        }

		function drawHistory() {
			const hCont = document.getElementById('historyContainer');
            
            // Logic: Hide if empty, Show if has data
            if (history.length === 0) {
                hCont.style.display = 'none';
                return;
            } else {
                hCont.style.display = 'flex';
            }

			hCont.innerHTML = '<span class="history-label">History</span>';
			
			history.forEach(val => {
				const d = document.createElement('div');
				d.className = 'history-dot';
				d.innerText = val;
				
				if(val === 0 || val === '00') d.classList.add('dot-green');
				else if(REDS.includes(val)) d.classList.add('dot-red');
				else d.classList.add('dot-black');
				
				hCont.appendChild(d);
			});
		}

        function restartGame() {
            playSound('click');
            balance = 500;
            localStorage.setItem('rouletteBalance', balance); // Save reset balance
            document.getElementById('gameOverModal').style.display = 'none';
            showMsg("New Game Started");
            updateUI();
        }
    </script>
</body>
</html>
